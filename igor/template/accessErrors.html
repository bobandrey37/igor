$def with ()
$code:
	def showtime(tstr):
		if not tstr: return tstr
		t = float(tstr)
		return time.strftime("%d/%b/%Y %H:%M:%S", time.localtime(t))
		
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Igor Access Control Failures</title>
	<style>
	table, th, td {
		border: 1px solid black;
		border-collapse: collapse;
	}
	</style>
</head>
<body>
	<h1>Igor Access Control Failures</h1>
	$if not igor.internal.accessControl('hasCapabilitySupport'):
		<p>This Igor runs without capability support. It is unlikely you see anything interesting here.</p>

	$if 'user' in igor.session and igor.session.user:
		<p>You are logged in as $igor.session.user.</p>
		
	<p>
		This page lists all access control failures (missing capabilities) encountered by Igor in the current invocation.
		(So, this information may be incorrect, because issues have been fixed already, and may be incomplete because Igor
		may have restarted since a failure). For each failure the first occurrence is shown, so you can look it up in <a href="/internal/log">the Igor log</a>.
	</p>
	
	<p>
		If you (the user currently logged in) <i>do</i> have the correct capabilities to allow the operation you will see a <i>Fix</i>
		button which will create the capability and assign it to the action. Or you may see a <i>Create</i> button which will create the
		correct capability in your user account, so you can export it to the device that issued the request.
	</p>
	
	$ errors = igor.databaseAccessor.get_key('services/igor/accessFailures', 'application/x-python-object', 'content', token)
	$if 'accessFailure' in errors:
		$ errors = errors['accessFailure']
		$ if type(errors) != type([]): errors = [errors]
	$else:
		$ errors = []
	
	<table style="width:100%">
		<tr>
			<th>time</th>
			<th>action</th>
			<th>request path</th>
			<th>op</th>
			<th>path</th>
			<th>capabilities</th>
			<th>...</th>
			<th>Can fix?</th>
		</tr>
		$for error in errors:
			$ keep = dict(error)
			<tr>
				<td>${showtime(error.pop('timestamp', ''))}</td>
				<td>
					${error.pop('action', '')}
					$if 'representing' in error:
						<br><i>representing ${error.pop('representing', '')}</i>
				</td>
				<td>${error.pop('requestPath', '')}</td>
				<td>${error.pop('operation', '')}</td>
				<td>
					${error.pop('path', '')}
					$if 'external' in error:
						<br><i>external=${error.pop('external','')}</i>
				</td>
				<td>
					$for cid in error.pop('capID', []):
						${cid}<br>
				</td>
				<td>
					$for k, v in error.items():
						${k}=${str(v)}<br>
				</td>
				<td>
					$if 'path' in keep and 'operation' in keep:
						$ myCaps = igor.access.findCompatibleTokens(token, keep['path'], **{keep['operation']:'self'})
						$if myCaps:
							$if 'action' in keep:
								Can Fix
							$else:
								Can Create
				</td>
			</tr>
	</table>
	
</body>
</html>