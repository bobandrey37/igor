$def with ()
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Igor System Health</title>
	<style>
	table, th, td {
		border: 1px solid black;
		border-collapse: collapse;
	}
	</style>
</head>
<body>
	<h1>Igor System Health</h1>
	
	<p>
		Igor has been running since ${DATABASE.getValue('/data/environment/introspection/lastActivity/reboot')},
		and was rebooted ${DATABASE.getValue('/data/environment/introspection/rebootCount')} times during its lifetime.
	</p>
	
	<h2>Exceptional conditions</h2>
	
	$ messages = DATABASE.getValues('/data/environment/systemHealth/messages/*')
	$if messages:
		<p>The following exceptional conditions (for services, sensors and actuators) are currently noted:</p>
		<ul>
			$for xp, msg in messages:
				<li>$msg</li>
		</ul>
	$else:
		<p>Igor is currently not aware of any exceptional conditions (for services, sensors and actuators). </p>
		
	<h2>Igor selfcheck status</h2>
	
	$ functionalities = DATABASE.getElements('/data/status/igor/*')
	<table style="width:100%">
		<tr>
			<th>Functionality</th>
			<th>Alive?</th>
			<th>Last Attempt</th>
			<th>Last Success</th>
			<th>Last Failure</th>
			<th>Current Error</th>
			<th>Ignored? (seconds)</th>
			<th>Ignore</th>
		</tr>
		$for s in functionalities:
			<tr>
				<td>$s.tagName</td>
				<td>${DATABASE.getValue('/data/status/igor/' + s.tagName + '/alive')}</td>
				
				$code:
					lastActivity = DATABASE.getValue('/data/status/igor/' + s.tagName + '/lastActivity')
					if lastActivity: lastActivity = DATABASE.getValue('igor_dateTime(/data/status/igor/' + s.tagName + '/lastActivity)')	
				<td>$lastActivity</td>
				
				$code:
					lastSuccess = DATABASE.getValue('/data/status/igor/' + s.tagName + '/lastSuccess')
					if lastSuccess: lastSuccess = DATABASE.getValue('igor_dateTime(/data/status/igor/' + s.tagName + '/lastSuccess)')
				<td>$lastSuccess</td>
				
				$code:
					lastFailure = DATABASE.getValue('/data/status/igor/' + s.tagName + '/lastFailure')
					if lastFailure: lastFailure = DATABASE.getValue('igor_dateTime(/data/status/igor/' + s.tagName + '/lastFailure)')
				<td>$lastFailure</td>
				
				$ msg = DATABASE.getValue('/data/status/igor/' + s.tagName + '/errorMessage')
				<td>$msg</td>
				
				$code:
					muted = DATABASE.getValue('/data/status/igor/' + s.tagName + '/ignoreErrorUntil')
					if muted:
						muted = DATABASE.getValue('igor_dateTime(/data/status/igor/' + s.tagName + '/ignoreErrorUntil)')
				<td>$muted</td>
				
				$if msg:
					<td>
						<a href="/plugin/systemHealth?ignore=igor/${s.tagName}&duration=3600">1h</a> 
						<a href="/plugin/systemHealth?ignore=igor/${s.tagName}&duration=86400">1d</a> 
						<a href="/plugin/systemHealth?ignore=igor/${s.tagName}&duration=604800">1w</a> 
						<a href="/plugin/systemHealth?ignore=igor/${s.tagName}&duration=2592000">1m</a>
					</td>
				$else:
					<td></td>
			</tr>
	</table>
		
	<h2>Service status</h2>
	
	$ services = DATABASE.getElements('/data/status/services/*')
	<table style="width:100%">
		<tr>
			<th>Service</th>
			<th>Alive?</th>
			<th>Last Attempt</th>
			<th>Last Success</th>
			<th>Last Failure</th>
			<th>Current Error</th>
			<th>Ignored? (seconds)</th>
			<th>Ignore</th>
		</tr>
		$for s in services:
			<tr>
				<td>$s.tagName</td>
				<td>${DATABASE.getValue('/data/status/services/' + s.tagName + '/alive')}</td>
				
				$code:
					lastActivity = DATABASE.getValue('/data/status/services/' + s.tagName + '/lastActivity')
					if lastActivity: lastActivity = DATABASE.getValue('igor_dateTime(/data/status/services/' + s.tagName + '/lastActivity)')
				<td>$lastActivity</td>

				$code:
					lastSuccess = DATABASE.getValue('/data/status/services/' + s.tagName + '/lastSuccess')
					if lastSuccess: lastSuccess = DATABASE.getValue('igor_dateTime(/data/status/services/' + s.tagName + '/lastSuccess)')
				<td>$lastSuccess</td>

				$code:
					lastFailure = DATABASE.getValue('/data/status/services/' + s.tagName + '/lastFailure')
					if lastFailure: lastFailure = DATABASE.getValue('igor_dateTime(/data/status/services/' + s.tagName + '/lastFailure)')
				<td>$lastFailure</td>

				$ msg = DATABASE.getValue('/data/status/services/' + s.tagName + '/errorMessage')
				<td>$msg</td>

				$code:
					muted = DATABASE.getValue('/data/status/services/' + s.tagName + '/ignoreErrorUntil')
					if muted:
						muted = DATABASE.getValue('igor_dateTime(/data/status/services/' + s.tagName + '/ignoreErrorUntil)')
				<td>$muted</td>

				$if msg:
					<td>
						<a href="/plugin/systemHealth?ignore=services/${s.tagName}&duration=3600">1h</a> 
						<a href="/plugin/systemHealth?ignore=services/${s.tagName}&duration=86400">1d</a> 
						<a href="/plugin/systemHealth?ignore=services/${s.tagName}&duration=604800">1w</a> 
						<a href="/plugin/systemHealth?ignore=services/${s.tagName}&duration=2592000">1m</a>
					</td>
				$else:
					<td></td>
			</tr>
	</table>
		
		
	<h2>Sensor status</h2>
	
	$ sensors = DATABASE.getElements('/data/status/sensors/*')
	<table style="width:100%">
		<tr>
			<th>Sensor Class</th>
			<th>Alive?</th>
			<th>Last Activity</th>
			<th>Last Success</th>
			<th>Last Failure</th>
			<th>Current Error</th>
			<th>Ignored? (seconds)</th>
			<th>Ignore</th>
		</tr>
		$for s in sensors:
			<tr>
				<td>$s.tagName</td>
				<td>${DATABASE.getValue('/data/status/sensors/' + s.tagName + '/alive')}</td>
				
				$code:
					lastActivity = DATABASE.getValue('/data/status/sensors/' + s.tagName + '/lastActivity')
					if lastActivity: lastActivity = DATABASE.getValue('igor_dateTime(/data/status/sensors/' + s.tagName + '/lastActivity)')
				<td>$lastActivity</td>

				$code:
					lastSuccess = DATABASE.getValue('/data/status/sensors/' + s.tagName + '/lastSuccess')
					if lastSuccess: lastSuccess = DATABASE.getValue('igor_dateTime(/data/status/sensors/' + s.tagName + '/lastSuccess)')
				<td>$lastSuccess</td>

				$code:
					lastFailure = DATABASE.getValue('/data/status/sensors/' + s.tagName + '/lastFailure')
					if lastFailure: lastFailure = DATABASE.getValue('igor_dateTime(/data/status/sensors/' + s.tagName + '/lastFailure)')
				<td>$lastFailure</td>

				$ msg = DATABASE.getValue('/data/status/sensors/' + s.tagName + '/errorMessage')
				<td>$msg</td>

				$code:
					muted = DATABASE.getValue('/data/status/sensors/' + s.tagName + '/ignoreErrorUntil')
					if muted:
						muted = DATABASE.getValue('igor_dateTime(/data/status/sensors/' + s.tagName + '/ignoreErrorUntil)')
				<td>$muted</td>

				$if msg:
					<td>
						<a href="/plugin/systemHealth?ignore=sensors/${s.tagName}&duration=3600">1h</a> 
						<a href="/plugin/systemHealth?ignore=sensors/${s.tagName}&duration=86400">1d</a> 
						<a href="/plugin/systemHealth?ignore=sensors/${s.tagName}&duration=604800">1w</a> 
						<a href="/plugin/systemHealth?ignore=sensors/${s.tagName}&duration=2592000">1m</a>
					</td>
				$else:
					<td></td>
			</tr>
	</table>
		
	<h2>Device status</h2>
	
	$ devices = DATABASE.getElements('/data/devices/*')
	<table style="width:100%">
		<tr>
			<th>Device</th>
			<th>Alive?</th>
			<th>Last Activity</th>
			<th>Last Success</th>
			<th>Last Failure</th>
			<th>Current Error</th>
			<th>Ignored? (seconds)</th>
			<th>Ignore</th>
		</tr>
		$for s in devices:
			<tr>
				<td>$s.tagName</td>
				<td>${DATABASE.getValue('/data/status/devices/' + s.tagName + '/alive')}</td>

				$code:
					lastActivity = DATABASE.getValue('/data/status/devices/' + s.tagName + '/lastActivity')
					if lastActivity: lastActivity = DATABASE.getValue('igor_dateTime(/data/status/devices/' + s.tagName + '/lastActivity)')
					
				<td>$lastSuccess</td>
				$code:
					lastSuccess = DATABASE.getValue('/data/status/devices/' + s.tagName + '/lastSuccess')
					if lastSuccess: lastSuccess = DATABASE.getValue('igor_dateTime(/data/status/devices/' + s.tagName + '/lastSuccess)')
					
				<td>$lastSuccess</td>
				$code:
					lastFailure = DATABASE.getValue('/data/status/devices/' + s.tagName + '/lastFailure')
					if lastFailure: lastFailure = DATABASE.getValue('igor_dateTime(/data/status/devices/' + s.tagName + '/lastFailure)')
					
				<td>$lastFailure</td>
				$ msg = DATABASE.getValue('/data/status/devices/' + s.tagName + '/errorMessage')
				<td>$msg</td>
				$code:
					muted = DATABASE.getValue('/data/status/devices/' + s.tagName + '/ignoreErrorUntil')
					if muted:
						muted = DATABASE.getValue('igor_dateTime(/data/status/devices/' + s.tagName + '/ignoreErrorUntil)')
					
				<td>$muted</td>

				$if msg:
					<td>
						<a href="/plugin/systemHealth?ignore=devices/${s.tagName}&duration=3600">1h</a> 
						<a href="/plugin/systemHealth?ignore=devices/${s.tagName}&duration=86400">1d</a> 
						<a href="/plugin/systemHealth?ignore=devices/${s.tagName}&duration=604800">1w</a> 
						<a href="/plugin/systemHealth?ignore=devices/${s.tagName}&duration=2592000">1m</a>
					</td>
				$else:
					<td></td>
			</tr>
	</table>
		

</body>
</html>
